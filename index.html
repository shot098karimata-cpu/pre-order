<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テイクアウト注文シート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .order-sheet {
            transition: all 0.3s ease-in-out;
            border-color: #e5e7eb;
        }
        .order-sheet:not(:first-child) {
            margin-top: 2rem;
        }
        .required-label::after {
            content: '*';
            color: #ef4444;
            margin-left: 0.25rem;
        }
        .hidden {
            display: none;
        }
        /* ★★★ カスタム確認モーダルのスタイル ★★★ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">テイクアウト<br>注文シート</h1>
            <p class="text-gray-600 mt-2">ご注文内容をご入力ください。</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">お客様情報</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1 required-label">お名前</label>
                    <input type="text" id="customerName" name="customerName" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1 required-label">受取日時</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <select id="pickupDate" name="pickupDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></select>
                        </div>
                        <div>
                             <select id="pickupTime" name="pickupTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="order-sheets-container"></div>

        <div class="text-center mt-6">
            <p class="text-red-600 font-semibold">※お支払いは現金のみになります。</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mt-8">
            <button id="add-order-btn" class="w-full sm:w-auto flex-grow bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">
                注文を追加
            </button>
            <button id="submit-order-btn" class="w-full sm:w-auto flex-grow bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition duration-300 shadow-md">
                注文内容を確認する
            </button>
        </div>
    </div>

    <template id="order-sheet-template">
        </template>
    
    <div id="success-message" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl transition-transform transform translate-x-[120%]">
        <p>ご注文ありがとうございました！</p>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-4">最終確認画面</h2>
            <pre id="modal-summary" class="bg-gray-100 p-4 rounded-md text-sm whitespace-pre-wrap mb-6"></pre>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">修正する</button>
                <button id="modal-confirm-btn" class="bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-emerald-700 transition">この内容で送信</button>
            </div>
        </div>
    </div>

<script>
    liff.init({
        liffId: "2008011772-m1MB7kB8"
    })
    .then(() => {
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            main();
        }
    })
    .catch((err) => {
        console.error(err);
        alert('LIFFの初期化に失敗しました。ページを再読み込みしてください。');
    });

    function main() {
        // ... (ここから下の大部分は変更ありません) ...
        const orderSheetsContainer = document.getElementById('order-sheets-container');
        const template = document.getElementById('order-sheet-template');
        let orderCount = 0;

        // ★★★ 状態保存・復元機能の追加 ★★★
        const FORM_STORAGE_KEY = 'takeoutOrderState';

        const saveFormState = () => {
            const state = {
                customerName: document.getElementById('customerName').value,
                pickupDate: document.getElementById('pickupDate').value,
                pickupTime: document.getElementById('pickupTime').value,
                orderSheetsHTML: orderSheetsContainer.innerHTML,
                orderCount: orderCount
            };
            localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(state));
        };

        const loadFormState = () => {
            const savedState = localStorage.getItem(FORM_STORAGE_KEY);
            if (!savedState) return false;

            const state = JSON.parse(savedState);
            document.getElementById('customerName').value = state.customerName || '';
            
            // 日付と時間を復元
            populatePickupDates();
            document.getElementById('pickupDate').value = state.pickupDate;
            populatePickupTimes(state.pickupDate);
            document.getElementById('pickupTime').value = state.pickupTime;
            
            // 注文シートを復元
            orderSheetsContainer.innerHTML = state.orderSheetsHTML || '';
            orderCount = state.orderCount || 0;
            if (orderSheetsContainer.innerHTML === '') {
                addOrderSheet();
            }

            return true;
        };
        // ★★★ 状態保存ここまで ★★★

        const populatePickupDates = () => {
            // ... (変更ありません) ...
        };

        const populatePickupTimes = (selectedDate) => {
             // ... (変更ありません、10分枠のままです) ...
        };

        const addOrderSheet = () => {
            // ... (変更ありません) ...
        };

        const removeOrderSheet = (button) => {
            // ... (変更ありません) ...
        };

        const updateSheetTitles = () => {
             // ... (変更ありません) ...
        };

        const handleOrderTypeChange = (event) => {
             // ... (変更ありません) ...
        };

        const updateOrderTypeRequirements = (sheet) => {
            // ... (変更ありません) ...
        };
        
        const validateForms = () => {
             // ... (変更ありません) ...
        };
        
        const collectOrderData = () => {
             // ... (変更ありません) ...
        };

        const resetForm = () => {
            // ... (変更後) ...
            localStorage.removeItem(FORM_STORAGE_KEY); // 状態をクリア
            // ... (以降は変更ありません) ...
        };

        const showSuccessMessage = () => {
            // ... (変更ありません) ...
        };
        
        // ★★★ 確認モーダルを使うようにhandleSubmitを修正 ★★★
        const handleSubmit = () => {
            if (!validateForms()) {
                return;
            }
            const { summary } = collectOrderData();
            
            const modal = document.getElementById('confirmation-modal');
            const summaryPre = document.getElementById('modal-summary');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            summaryPre.textContent = summary;
            modal.classList.add('visible');

            const confirmHandler = () => {
                modal.classList.remove('visible');
                liff.getFriendship()
                    .then(data => {
                        if (data.friendFlag) {
                            liff.sendMessages([{ type: 'text', text: summary }])
                                .then(() => {
                                    alert('お店に注文内容を送信しました！');
                                    showSuccessMessage();
                                    setTimeout(() => {
                                        resetForm();
                                        liff.closeWindow();
                                    }, 500);
                                })
                                .catch((err) => {
                                    alert('送信に失敗しました。');
                                    console.error('sendMessages Error:', err);
                                });
                        } else {
                            alert('メッセージを送信するには、まず公式アカウントと友だちになってください。');
                        }
                    })
                    .catch((err) => {
                        alert('この機能は、お店の公式アカウントとのトーク画面から開いた場合のみ利用できます。\nお手数ですが、リッチメニューなどから再度開いてください。');
                        console.error('getFriendship Error:', err);
                    });
                
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                modal.classList.remove('visible');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        };

        // --- イベントリスナー設定 ---
        const container = document.querySelector('.container');
        container.addEventListener('click', (event) => {
            if (event.target.id === 'add-order-btn') addOrderSheet();
            if (event.target.id === 'submit-order-btn') handleSubmit();
        });
        orderSheetsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-order-btn')) removeOrderSheet(event.target);
        });
        container.addEventListener('change', (event) => {
            if (event.target.classList.contains('order-type')) handleOrderTypeChange(event);
            if (event.target.id === 'pickupDate') {
                populatePickupTimes(event.target.value);
            }
            saveFormState(); // フォーム内容の変更時に状態を保存
        });
        
        // --- 初期化処理 ---
        liff.getProfile()
            .then(profile => {
                if (!loadFormState()) { // 保存されたデータがなければ初期化
                    document.getElementById('customerName').value = profile.displayName;
                    const dateSelect = document.getElementById('pickupDate');
                    populatePickupDates();
                    populatePickupTimes(dateSelect.value);
                    addOrderSheet();
                }
            })
            .catch((err) => {
                console.error('プロフィールの取得に失敗しました', err);
                const dateSelect = document.getElementById('pickupDate');
                populatePickupDates();
                populatePickupTimes(dateSelect.value);
                addOrderSheet();
            });
    }
</script>
</body>
</html>
