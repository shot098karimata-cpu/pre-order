<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テイクアウト注文シート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .order-sheet { transition: all 0.3s ease-in-out; border-color: #e5e7eb; }
        .order-sheet:not(:first-child) { margin-top: 2rem; }
        .required-label::after { content: '*'; color: #ef4444; margin-left: 0.25rem; }
        .hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-button {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">テイクアウト<br>注文シート</h1>
            <p class="text-gray-600 mt-2">ご注文内容をご入力ください。</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">お客様情報</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1 required-label">お名前</label>
                    <input type="text" id="customerName" name="customerName" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1 required-label">受取日時</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <select id="pickupDate" name="pickupDate" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></select>
                        </div>
                        <div>
                             <select id="pickupTime" name="pickupTime" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="order-sheets-container"></div>
        <div class="text-center mt-6">
            <p class="text-red-600 font-semibold">※お支払いは現金のみになります。</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 mt-8">
            <button id="add-order-btn" class="w-full sm:w-auto flex-grow bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">注文を追加</button>
            <button id="submit-order-btn" class="w-full sm:w-auto flex-grow bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition duration-300 shadow-md">注文内容を確認する</button>
        </div>
    </div>

    <template id="order-sheet-template">
        <div class="order-sheet bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-500">
            <div class="flex justify-between items-center border-b pb-3 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 sheet-title">注文 1</h3>
                <button type="button" class="remove-order-btn text-red-500 hover:text-red-700 font-semibold py-1 px-3 rounded-md transition duration-300">この注文をキャンセル</button>
            </div>
            <form class="order-form space-y-8">
                <fieldset>
                    <legend class="text-lg font-semibold text-gray-900 mb-2 required-label">１．サイズ（ライスの量）</legend>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="size" value="Sサイズ (140g)" class="mr-2" required>Sサイズ (140g)</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="size" value="Mサイズ (180g)" class="mr-2">Mサイズ (180g)</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="size" value="Lサイズ (220g)" class="mr-2">Lサイズ (220g)</label>
                    </div>
                </fieldset>
                <fieldset>
                    <legend class="text-lg font-semibold text-gray-900 mb-2 required-label">２．SET/単品</legend>
                    <div class="flex flex-wrap items-center gap-4">
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="type" value="SET" class="mr-2 order-type" required>SET</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="type" value="単品" class="mr-2 order-type">単品</label>
                        <span class="text-sm text-red-600 set-description hidden">（SET内容トッピング＋ドリンク各１種）</span>
                    </div>
                </fieldset>
                <fieldset class="topping-fieldset">
                    <legend class="text-lg font-semibold text-gray-900 mb-2 topping-label">3. トッピング (複数選択可)</legend>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="アボカド" class="mr-2" data-price="150">アボカド</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="パクチー" class="mr-2" data-price="150">パクチー</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="目玉焼き" class="mr-2" data-price="150">目玉焼き</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="ジューシーベーコン" class="mr-2" data-price="150">ジューシーベーコン</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="スパム" class="mr-2" data-price="150">スパム</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="焼き野菜" class="mr-2" data-price="150">焼き野菜</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="topping" value="マグマソース" class="mr-2" data-price="150">マグマソース</label>
                    </div>
                    <p class="text-red-600 text-sm mt-4">※「追いチーズ」と「追加ライス」は<br>容器の関係上出来ません。</p>
                </fieldset>
                <div class="drink-fieldset hidden">
                    <label class="text-lg font-semibold text-gray-900 mb-2 drink-label">4. ドリンク</label>
                    <select name="drink" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- 選択してください --</option>
                        <option value="コーラ">コーラ</option>
                        <option value="ジンジャーエール">ジンジャーエール</option>
                        <option value="カルピス">カルピス</option>
                        <option value="さんぴん茶">さんぴん茶</option>
                        <option value="ウーロン茶">ウーロン茶</option>
                        <option value="ホットウーロン茶">ホットウーロン茶</option>
                        <option value="アイスコーヒー">アイスコーヒー</option>
                        <option value="沖縄バヤリース">沖縄バヤリース</option>
                    </select>
                </div>
                <fieldset>
                    <legend class="text-lg font-semibold text-gray-900 mb-2 required-label">5. タコスミート</legend>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="meat" value="ひき肉" class="mr-2" required>ひき肉</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="meat" value="ハーフ＆ハーフ" class="mr-2">ハーフ＆ハーフ</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="radio" name="meat" value="カルニタス" class="mr-2">カルニタス</label>
                    </div>
                    <p class="text-red-600 text-sm mt-4">※「カルニタス」が完売になっている場合、「ひき肉」のみでのご提供となります。</p>
                </fieldset>
                <fieldset class="sauce-fieldset">
                    <legend class="text-lg font-semibold text-gray-900 mb-2 required-label">6. ソース選択（２種類まで）</legend>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="sauce" value="ホットソース" class="mr-2">ホットソース</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="sauce" value="ベーシックソース" class="mr-2">ベーシックソース</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="sauce" value="バーベキューソース" class="mr-2">バーベキューソース</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="sauce" value="ベジタブルソース" class="mr-2">ベジタブルソース</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="sauce" value="チミチュリソース" class="mr-2">チミチュリソース</label>
                        <label class="flex items-center p-3 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 cursor-pointer"><input type="checkbox" name="sauce" value="サワークリームソース" class="mr-2">サワークリームソース</label>
                    </div>
                </fieldset>
                <div>
                    <label class="text-lg font-semibold text-gray-900 mb-2 block">7. 備考</label>
                    <textarea name="remarks" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="例：チーズ抜き、豚アレルギーがあります。"></textarea>
                </div>
            </form>
        </div>
    </template>
    
    <div id="success-message" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl transition-transform transform translate-x-[120%]">
        <p>ご注文ありがとうございました！</p>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-4">最終確認画面</h2>
            <pre id="modal-summary" class="bg-gray-100 p-4 rounded-md text-sm whitespace-pre-wrap mb-6"></pre>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel-btn" class="modal-button bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition">修正する</button>
                <button id="modal-confirm-btn" class="modal-button bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition">この内容で送信</button>
            </div>
        </div>
    </div>

<script>
    async function main() {
        // --- 変数と要素の定義 ---
        const orderSheetsContainer = document.getElementById('order-sheets-container');
        const template = document.getElementById('order-sheet-template');
        let orderCount = 0;

        // --- 関数定義 ---
        const populatePickupDates = () => {
            const dateSelect = document.getElementById('pickupDate');
            if (!dateSelect) return;
            dateSelect.innerHTML = '';
            const today = new Date();
            const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = weekdays[date.getDay()];
                const option = document.createElement('option');
                option.value = `${date.getFullYear()}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                option.textContent = i === 0 ? `今日 ${month}/${day}(${weekday})` : `${month}/${day}(${weekday})`;
                dateSelect.appendChild(option);
            }
        };

        const populatePickupTimes = (selectedDate) => {
            const timeSelect = document.getElementById('pickupTime');
            if (!timeSelect) return;
            timeSelect.innerHTML = '';
            const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            const openingHour = 11, openingMinute = 30, closingHour = 16;
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const isToday = selectedDate === todayStr;
            
            let startTime;
            if (isToday) {
                let nowPlus10 = new Date();
                nowPlus10.setMinutes(nowPlus10.getMinutes() + 10);
                const remainder = nowPlus10.getMinutes() % 5;
                if (remainder !== 0) nowPlus10.setMinutes(nowPlus10.getMinutes() + (5 - remainder));
                
                const openingTime = new Date();
                openingTime.setHours(openingHour, openingMinute, 0, 0);
                startTime = nowPlus10 > openingTime ? nowPlus10 : openingTime;
            } else {
                startTime = new Date(selectedDate + 'T00:00:00');
                startTime.setHours(openingHour, openingMinute, 0, 0);
            }

            const endTime = new Date(startTime);
            endTime.setHours(closingHour, 0, 0, 0);

            let timeOptionsAvailable = false;
            let currentTime = new Date(startTime.getTime());

            while (currentTime < endTime) {
                const slotStart = new Date(currentTime.getTime());
                const slotEnd = new Date(currentTime.getTime());
                slotEnd.setMinutes(slotEnd.getMinutes() + 10);

                if (slotEnd > endTime) break;

                const timeString = `${formatTime(slotStart)}～${formatTime(slotEnd)}`;
                const option = document.createElement('option');
                option.value = timeString;
                option.textContent = timeString;
                timeSelect.appendChild(option);
                timeOptionsAvailable = true;
                currentTime.setMinutes(currentTime.getMinutes() + 5);
            }

            if (!timeOptionsAvailable) {
                const closedOption = document.createElement('option');
                closedOption.value = "";
                closedOption.textContent = isToday ? "本日の受付は終了しました" : "受付時間外です";
                closedOption.disabled = true;
                timeSelect.appendChild(closedOption);
            }
        };

        const handleSauceChange = (event) => {
            const fieldset = event.currentTarget;
            const checkboxes = fieldset.querySelectorAll('input[type="checkbox"]');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            checkboxes.forEach(cb => {
                if (!cb.checked && checkedCount >= 2) {
                    cb.disabled = true;
                    cb.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    cb.disabled = false;
                    cb.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        };

        const addOrderSheet = () => {
            orderCount++;
            const newSheet = template.content.cloneNode(true);
            const sheetDiv = newSheet.querySelector('.order-sheet');
            sheetDiv.dataset.orderId = orderCount;
            const formElements = newSheet.querySelectorAll('input, select, textarea');
            formElements.forEach(el => {
                if (el.name) el.name = `${el.name}-${orderCount}`;
            });
            newSheet.querySelector('.sheet-title').textContent = `注文 ${orderCount}`;
            
            const sauceFieldset = newSheet.querySelector('.sauce-fieldset');
            sauceFieldset.addEventListener('change', handleSauceChange);

            orderSheetsContainer.appendChild(newSheet);
            updateOrderTypeRequirements(sheetDiv);
            updateSheetTitles();
        };

        const removeOrderSheet = (button) => {
            if (confirm('この注文をキャンセルしますか？')) {
                const sheetToRemove = button.closest('.order-sheet');
                sheetToRemove.remove();
                updateSheetTitles();
            }
        };

        const updateSheetTitles = () => {
            const allSheets = document.querySelectorAll('.order-sheet');
            allSheets.forEach((sheet, index) => {
                sheet.querySelector('.sheet-title').textContent = `注文 ${index + 1}`;
            });
        };

        const handleOrderTypeChange = (event) => {
            const sheet = event.target.closest('.order-sheet');
            updateOrderTypeRequirements(sheet);
        };

        const updateOrderTypeRequirements = (sheet) => {
            const orderId = sheet.dataset.orderId;
            const typeRadio = sheet.querySelector(`input[name="type-${orderId}"]:checked`);
            const isSet = typeRadio && typeRadio.value === 'SET';
            const drinkFieldset = sheet.querySelector('.drink-fieldset');
            const drinkSelect = sheet.querySelector(`select[name="drink-${orderId}"]`);
            
            drinkFieldset.classList.toggle('hidden', !isSet);
            drinkSelect.required = isSet;
            if (!isSet) drinkSelect.value = '';
        };

        const validateForms = () => {
            // (この関数は変更ありません)
            const customerName = document.getElementById('customerName').value.trim();
            const pickupDate = document.getElementById('pickupDate').value;
            const pickupTime = document.getElementById('pickupTime').value;
            if (!customerName || !pickupDate || !pickupTime) {
                alert('お客様情報の必須項目（お名前、受取日時）をすべて入力してください。');
                return false;
            }
            const allSheets = document.querySelectorAll('.order-sheet');
            if (allSheets.length === 0) {
                alert('少なくとも1つの注文を追加してください。');
                return false;
            }
            for (const sheet of allSheets) {
                const form = sheet.querySelector('.order-form');
                const sheetTitle = sheet.querySelector('.sheet-title').textContent;
                const orderId = sheet.dataset.orderId;
                if (!form.checkValidity()) {
                    alert(`${sheetTitle}に未入力の項目があります。`);
                    form.reportValidity();
                    return false;
                }
                const typeRadio = sheet.querySelector(`input[name="type-${orderId}"]:checked`);
                if (typeRadio && typeRadio.value === 'SET') {
                    if (sheet.querySelectorAll(`input[name="topping-${orderId}"]:checked`).length === 0) {
                        alert(`${sheetTitle}でセットを選択した場合、トッピングを1つ以上選択してください。`);
                        return false;
                    }
                    if (!sheet.querySelector(`select[name="drink-${orderId}"]`).value) {
                        alert(`${sheetTitle}でセットを選択した場合、ドリンクを選択してください。`);
                        return false;
                    }
                }
                const checkedSauces = sheet.querySelectorAll(`input[name="sauce-${orderId}"]:checked`).length;
                if (checkedSauces === 0) {
                    alert(`${sheetTitle}でソースを1つ以上選択してください。`);
                    return false;
                }
                 if (checkedSauces > 2) {
                    alert(`${sheetTitle}で選択できるソースは2つまでです。`);
                    return false;
                }
            }
            return true;
        };
        
        const collectOrderData = () => {
            // (この関数は変更ありません)
            const priceMap = { "Sサイズ (140g)":{単品:1e3,SET:1320},"Mサイズ (180g)":{単品:1100,SET:1430},"Lサイズ (220g)":{単品:1200,SET:1540} };
            const drinkPrice = 350;
            const customerName = document.getElementById('customerName').value.trim();
            const pickupDateSelect = document.getElementById('pickupDate');
            const pickupDate = pickupDateSelect.options[pickupDateSelect.selectedIndex].textContent;
            const pickupTime = document.getElementById('pickupTime').value;
            let summary = `【お客様情報】\nお名前: ${customerName}様\n受取日時: ${pickupDate} ${pickupTime}\n------------------------------\n\n`;
            let grandTotal = 0;
            document.querySelectorAll('.order-sheet').forEach((sheet, index) => {
                let sheetTotal = 0;
                const orderId = sheet.dataset.orderId;
                const form = sheet.querySelector('.order-form');
                const formData = new FormData(form);
                summary += `【注文 ${index + 1}】\n`;
                const sizeInput = sheet.querySelector(`input[name="size-${orderId}"]:checked`);
                const typeInput = sheet.querySelector(`input[name="type-${orderId}"]:checked`);
                if (sizeInput && typeInput) {
                    sheetTotal += priceMap[sizeInput.value][typeInput.value] || 0;
                    summary += `サイズ: ${sizeInput.value}\n種類: ${typeInput.value}\n`;
                }
                const toppingInputs = sheet.querySelectorAll(`input[name="topping-${orderId}"]:checked`);
                const isSet = typeInput && typeInput.value === 'SET';
                if (toppingInputs.length > 0) {
                    const toppingValues = [];
                    toppingInputs.forEach((input, i) => {
                        toppingValues.push(input.value);
                        if (!(isSet && i === 0)) sheetTotal += parseFloat(input.dataset.price || 0);
                    });
                    summary += `トッピング: ${toppingValues.join(', ')}\n`;
                }
                const drinkValue = formData.get(`drink-${orderId}`);
                if (isSet && drinkValue) {
                    summary += `ドリンク: ${drinkValue}\n`;
                } else if (drinkValue) {
                    summary += `追加ドリンク: ${drinkValue}\n`;
                    sheetTotal += drinkPrice;
                }
                const meatInput = sheet.querySelector(`input[name="meat-${orderId}"]:checked`);
                summary += meatInput ? `タコスミート: ${meatInput.value}\n` : 'タコスミート: 未選択\n';
                const sauceValues = formData.getAll(`sauce-${orderId}`);
                if (sauceValues.length > 0) summary += `ソース: ${sauceValues.join(', ')}\n`;
                const remarks = formData.get(`remarks-${orderId}`);
                if (remarks && remarks.trim() !== '') summary += `備考: ${remarks.trim()}\n`;
                summary += `\n--- この注文の合計: ${sheetTotal}円 ---\n\n`;
                grandTotal += sheetTotal;
            });
            summary += `------------------------------\n総合計: ${grandTotal}円\n※お支払いは現金のみになります。\n※テイクアウトの対応は、店舗右側窓口にて対応いたします。。\n`;
            return { summary, grandTotal, customerName };
        };

        const resetForm = () => {
            document.getElementById('customerName').value = '';
            orderSheetsContainer.innerHTML = '';
            orderCount = 0;
            initializeForm();
        };

        const showSuccessMessage = () => {
            const successMessage = document.getElementById('success-message');
            successMessage.classList.remove('translate-x-[120%]');
            setTimeout(() => {
                successMessage.classList.add('translate-x-[120%]');
            }, 4000);
        };
        
        const handleSubmit = () => {
            if (!validateForms()) return;
            const { summary } = collectOrderData();
            
            const modal = document.getElementById('confirmation-modal');
            const summaryPre = document.getElementById('modal-summary');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            summaryPre.textContent = summary;
            modal.classList.add('visible');

            const confirmHandler = () => {
                modal.classList.remove('visible');
                liff.sendMessages([{ type: 'text', text: summary }])
                    .then(() => {
                        alert('お店に注文内容を送信しました！');
                        showSuccessMessage();
                        setTimeout(() => {
                            resetForm();
                            liff.closeWindow();
                        }, 500);
                    })
                    .catch((err) => {
                        alert('メッセージ送信に失敗しました。この機能は公式アカウントとのトーク画面からのみ利用できます。');
                        console.error('sendMessages Error:', err);
                    });
                
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                modal.classList.remove('visible');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        };

        const initializeForm = (profileName = '') => {
            if (profileName) document.getElementById('customerName').value = profileName;
            populatePickupDates();
            const dateSelect = document.getElementById('pickupDate');
            populatePickupTimes(dateSelect.value);
            addOrderSheet();
        };
        
        // --- イベントリスナー設定 ---
        document.body.addEventListener('click', (event) => {
            if (event.target.id === 'add-order-btn') addOrderSheet();
            if (event.target.id === 'submit-order-btn') handleSubmit();
            if (event.target.classList.contains('remove-order-btn')) removeOrderSheet(event.target);
        });
        
        document.body.addEventListener('change', (event) => {
            if (event.target.classList.contains('order-type')) handleOrderTypeChange(event);
            if (event.target.id === 'pickupDate') populatePickupTimes(event.target.value);
        });
        
        // --- 初期化処理 ---
        liff.getProfile()
            .then(profile => initializeForm(profile.displayName))
            .catch(err => {
                console.error("Profile Error:", err);
                initializeForm();
            });
    }

    // LIFFの初期化とメイン関数の呼び出し
    liff.ready.then(() => {
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            main();
        }
    }).catch(err => {
        console.error("LIFF Init Error:", err);
        alert('LIFFの初期化に失敗しました。ページを再読み込みしてください。');
    });

</script>
</body>
</html>
